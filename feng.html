<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WWF & CYP: Cyber Love 520</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #FFFFFF; /* åº•éƒ¨ç™½è‰² */
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            touch-action: none;
            color: #fff;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* å¤©ç©ºèƒŒæ™¯ï¼Œä»ä¸‹å¾€ä¸Šï¼šåº•éƒ¨å¤§é¢ç§¯ç™½è‰² + ä¸Šæ–¹è“è‰²ï¼ˆæ— å¤–åœˆé˜´å½±ï¼‰ */
            background: linear-gradient(
                180deg,
                #FFFFFF 0%,
                #FFFFFF 45%,
                #E3F2FD 70%,
                #90CAF9 85%,
                #42A5F5 100%
            );
            box-shadow: none;
        }

        canvas {
            box-shadow: none;
            background: transparent;
            border-bottom: 2px solid #f0f;
        }

        /* éœ“è™¹ UI */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(10, 10, 20, 0.95);
            color: #0ff;
            z-index: 10;
            text-align: center;
            transition: opacity 0.5s;
            backdrop-filter: blur(8px);
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            margin-bottom: 20px;
            color: #f0f;
            text-shadow: 0 0 10px #f0f, 0 0 20px #f0f, 0 0 40px #f0f;
            letter-spacing: 2px;
            line-height: 1.4;
        }

        p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
            max-width: 80%;
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
        }

        .btn {
            padding: 15px 50px;
            font-size: 1.5rem;
            background: rgba(0, 255, 255, 0.1);
            color: #0ff;
            border: 2px solid #0ff;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: none;
            font-family: 'ZCOOL KuaiLe', sans-serif;
            transition: all 0.2s;
            text-transform: uppercase;
            margin-top: 20px;
        }

        .btn:hover {
            background: #0ff;
            color: #000;
            box-shadow: none; /* å»æ‰æ‚¬åœæ—¶çš„å‘å…‰é˜´å½± */
            transform: scale(1.03);
        }

        /* æ”»å‡»æŒ‰é’® */
        #attack-btn {
            position: absolute;
            bottom: 50px;
            right: 40px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 0, 255, 0.2);
            color: #f0f;
            font-size: 1.1rem;
            border: 3px solid #f0f;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: none;
            user-select: none;
            z-index: 5;
            font-family: 'ZCOOL KuaiLe', sans-serif;
            font-weight: bold;
            -webkit-tap-highlight-color: transparent;
        }
        
        #attack-btn:active {
            background: #f0f;
            color: #fff;
            transform: scale(0.9);
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.1rem;
            color: #fff;
            pointer-events: none;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px #0ff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.6);
            border-left: 3px solid #0ff;
            padding: 8px 15px;
            border-radius: 0 10px 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(4px);
        }

        /* ç»“ç®—/ç¿»ç‰Œç•Œé¢ */
        #ceremony-screen {
            background: linear-gradient(135deg, #2b1055 0%, #7597de 100%);
            padding-top: 40px;
            overflow-y: auto;
        }

        .wishes {
            font-size: 1.8rem;
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #f0f;
            animation: float 3s ease-in-out infinite;
        }

        .gift-display {
            font-size: 1.2rem;
            color: #ffd700;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ffd700;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            margin-bottom: 50px;
        }

        .card {
            background-color: transparent;
            width: 100%;
            padding-top: 100%;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
        }

        .card-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: none;
            border-radius: 10px;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 1rem;
            padding: 5px;
            box-sizing: border-box;
            font-weight: bold;
            border: 2px solid #0ff;
        }

        .card-front {
            background: #1a1a2e;
            color: #0ff;
            font-size: 2rem;
            text-shadow: 0 0 5px #0ff;
        }

        .card-back {
            background-color: #fff;
            color: #333;
            transform: rotateY(180deg);
            border: 2px solid #f0f;
            text-shadow: none;
            font-family: 'ZCOOL KuaiLe', sans-serif;
        }

        /* ç¿»ç‰Œä¸­"é©¬ä¸Šç»“å©š"è¿™å¼ ç‰¹æ®Šå¡ç‰‡çš„æ ·å¼ï¼ˆä½¿ç”¨ marry.png ä½œä¸ºèƒŒæ™¯ï¼‰ */
        .card-back.marry-card {
            background-image: url('marry.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #fff;
            border-color: #f0f;
            text-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: flex-end; /* æ–‡å­—é ä¸‹ */
            flex-direction: column;
            padding-bottom: 8px; /* åº•éƒ¨ç•™ä¸€ç‚¹å†…è¾¹è· */
        }

        .card-back.marry-card .marry-text {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.55);
            border-radius: 6px;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        #mobile-controls {
            display: none;
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            pointer-events: none;
            font-family: 'ZCOOL KuaiLe', sans-serif;
            text-shadow: 0 0 3px #000;
        }

        @media (max-width: 768px) {
            #mobile-controls { display: block; }
            h1 { font-size: 1.5rem; }
            .wishes { font-size: 1.4rem; }
            .grid-container { gap: 10px; }
            .card-back { font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-layer">
            <div class="stat-box">è·ç¦»: <span id="dist-display">0</span> / 520m</div>
            <div class="stat-box">ç§»æ¶²æª: <span id="ammo-display">3</span> å‘</div>
            <div class="stat-box" style="border-color: #ffd700; color: #ffd700;">é‡‘å¸: <span id="coin-display">0</span></div>
        </div>

        <div id="attack-btn" onclick="game.shoot()">
            å‘å°„<br>(F)
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="overlay">
            <h1>ğŸ‚ WWF ç”Ÿæ—¥å¤§å†’é™©<br><span style="font-size: 1.2rem; color:#fff">Target: 520m å¤„è¥æ•‘ CYP å…¬ä¸»</span></h1>
            <p>
                åœ¨è¿™ä¸ªèµ›åšå®éªŒå®¤é‡Œ...<br>
                èº²é¿ <span style="color:#f0f">ä¾¿ä¾¿</span> å’Œ <span style="color:#f0f">è´¨è°±ä»ª</span><br>
                <span style="color: #ffd700;">æ”¶é›†ç©ºä¸­çš„ã€è®ºæ–‡ã€‘èµšé‡‘å¸ï¼</span><br>
                ç”¨é‡‘å¸ç»™å…¬ä¸»ä¹°ç”Ÿæ—¥ç¤¼ç‰©ï¼
            </p>
            <p style="font-size: 0.9rem; color: #aaa;">
                ğŸ’» ç”µè„‘ï¼šç©ºæ ¼è·³è·ƒ / F å°„å‡»<br>
                ğŸ“± æ‰‹æœºï¼šç‚¹å‡»è·³è·ƒ / æŒ‰é’®å°„å‡»<br>
                (æ”¯æŒç©ºä¸­äºŒæ®µè·³å“¦ï¼)
            </p>
            <button class="btn" onclick="game.start()">å¼€å§‹è¡ŒåŠ¨</button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="overlay hidden">
            <h1 style="color: #ff3333;">å®éªŒæš‚åœ</h1>
            <p id="death-reason">è¢«éšœç¢ç‰©é˜»æŒ¡...</p>
            <button class="btn" onclick="game.reset()">å†æ¥ä¸€æ¬¡å§ï¼</button>
        </div>

        <!-- Ceremony Screen -->
        <div id="ceremony-screen" class="overlay hidden">
            <h1 style="color: #ffd700; margin-top:0;">ğŸ‰ ä»»åŠ¡å®Œæˆ ğŸ‰</h1>
            
            <div class="wishes">
                æˆåŠŸè¥æ•‘ CYP å…¬ä¸»ï¼
                <div style="font-size: 1.2rem; margin-top: 15px; color: #fff;">"ç¥ä½ ä¸‡äº‹èƒœæ„ å‰é€”äº®çš„çä¸å¼€çœ¼"</div>
            </div>

            <div id="gift-section" class="gift-display">
                æ­£åœ¨è®¡ç®—è®ºæ–‡å¥–åŠ±...
            </div>

            <p style="margin-bottom: 10px; font-size: 1rem; color: #fff;">ğŸ‘‡ ç¿»ç‰Œå­å†³å®šä»Šå¤©å»å“ªåº†ç¥ ğŸ‘‡</p>
            <div class="grid-container" id="card-grid"></div>
        </div>
        
        <div id="mobile-controls">ç‚¹å‡»å±å¹•è·³è·ƒ (å¯è¿è·³) / è§¦ç¢°å·¦ä¸‹è§’ä¸‹è¹²</div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const config = {
            gravity: 0.5,
            jumpForce: -11,
            groundHeight: 100, // å¢å¤§åœ°é¢é«˜åº¦
            speed: 3.5, // é€Ÿåº¦è°ƒæ…¢ï¼Œæ›´åŠ å®¹æ˜“
            levelLength: 520, // æµªæ¼«çš„è·ç¦»
            maxAmmo: 3
        };

        const sprites = {
            player: 'ğŸƒ',
            playerJump: 'ğŸš€',
            playerDuck: 'ğŸ›¡ï¸',
            weapon: 'ğŸ’‰', // ç§»æ¶²å™¨
            projectile: 'ğŸ’§', // è¯•å‰‚æ¶²æ»´
            princess: 'ğŸ‘¸ğŸ’–', // å¥½çœ‹çš„å…¬ä¸»+çˆ±å¿ƒ
            finish: 'ğŸ°', 
            coin: 'ğŸ’°',
            
            // éšœç¢ç‰©é…ç½® - ä¿æŒåŸå‘³å®éªŒå®¤å…ƒç´ ï¼Œå¢å¤§å°ºå¯¸
            obstacles: [
                // ä¾¿ä¾¿ç¨å¾®"é«˜ä¸€ç‚¹"ï¼šé€šè¿‡ yOffset æå‡æ•´ä½“ä½ç½®ä¸€ç‚¹ç‚¹
                { type: 'ground', icon: 'ğŸ’©', name: 'èµ›åšä¾¿ä¾¿', width: 50, height: 50, yOffset: 0 },
                { type: 'ground', icon: 'ğŸ“Ÿ', name: 'æ•…éšœè´¨è°±ä»ª', width: 70, height: 65, yOffset: 0 },
                // é¡¶éƒ¨ï¼ˆç©ºä¸­ï¼‰éšœç¢å†å¾€ä¸ŠæŒªä¸€äº›ï¼Œå‡å°‘ä¸äººç‰©å¤´é¡¶çš„è§†è§‰é‡åˆ
                { type: 'air', icon: 'ğŸ¦ ', name: 'å˜å¼‚ç»†èƒ', width: 50, height: 50, yOffset: 100 }, // åŸ 120 -> 150
                { type: 'air', icon: 'ğŸ§¬', name: 'åˆæˆç—…æ¯’', width: 50, height: 50, yOffset: 100 }, // åŸ  90 -> 130
                { type: 'ground', icon: 'ğŸ§ª', name: 'åŒ–å­¦åºŸæ¶²', width: 50, height: 55, yOffset: 0 },
            ],
            // æ”¶é›†å“ - è®ºæ–‡
            paper: { icon: 'ğŸ“„', name: 'SCIè®ºæ–‡', value: 100 }
        };

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                // å¯ç”¨é«˜è´¨é‡å›¾åƒå¹³æ»‘
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                // å­˜å‚¨æ˜¾ç¤ºå°ºå¯¸
                this.displayWidth = window.innerWidth > 1200 ? 1200 : window.innerWidth;
                this.displayHeight = 800;
                this.resize();
                
                this.state = 'START';
                this.frame = 0;
                this.distance = 0;
                this.coins = 0;
                this.married = false; // æ ‡è®°æ˜¯å¦å·²è§¦å‘ç»“å©šåœºæ™¯
                
                this.obstacles = [];
                this.collectibles = [];
                this.particles = [];
                this.projectiles = [];
                
                // åŠ è½½ç©å®¶å›¾ç‰‡
                this.playerImage = new Image();
                this.playerImage.src = 'feng3_PhotoGrid.png';
                this.playerImageLoaded = false;
                this.playerImage.onload = () => {
                    this.playerImageLoaded = true;
                    // æ ¹æ®å›¾ç‰‡å®é™…å°ºå¯¸è°ƒæ•´ç©å®¶å°ºå¯¸ï¼Œç¼©å°ä¸ºåŸæ¥çš„1/2
                    const aspectRatio = this.playerImage.width / this.playerImage.height;
                    // ç¼©å°æ˜¾ç¤ºå°ºå¯¸ä¸ºåŸæ¥çš„1/2ï¼Œå®½åº¦è®¾ä¸º 70-90ï¼Œæ ¹æ®ç”»å¸ƒå¤§å°è°ƒæ•´
                    const targetWidth = Math.min(90, this.displayWidth * 0.07);
                    this.player.width = targetWidth;
                    this.player.height = this.player.width / aspectRatio;
                    // å¦‚æœé«˜åº¦å¤ªå¤§ï¼Œä»¥é«˜åº¦ä¸ºå‡†é‡æ–°è®¡ç®—
                    const maxHeight = this.displayHeight * 0.14; // æœ€å¤§é«˜åº¦ä¸ºç”»å¸ƒçš„14%ï¼ˆåŸæ¥28%çš„ä¸€åŠï¼‰
                    if (this.player.height > maxHeight) {
                        this.player.height = maxHeight;
                        this.player.width = this.player.height * aspectRatio;
                    }
                    // é‡æ–°è®¾ç½®ç©å®¶ä½ç½®ï¼Œç¡®ä¿åœ¨åœ°é¢ä¸Š
                    this.player.y = this.displayHeight - config.groundHeight - this.player.height;
                };

                // åŠ è½½ç»ˆç‚¹å›¾ç‰‡ï¼ˆæ›¿æ¢åŸå…ˆçš„åŸå ¡ + å…¬ä¸» emoji æ•´ä½“æ•ˆæœï¼‰
                this.princessImage = new Image();
                this.princessImage.src = 'cyp1.png'; // ç»ˆç‚¹æ•´ä½“å›¾ç‰‡ï¼ˆå«åŸå ¡/å…¬ä¸»ç­‰å…ƒç´ ï¼‰
                this.princessImageLoaded = false;
                this.princessImage.onload = () => {
                    this.princessImageLoaded = true;
                };
                
                // åŠ è½½ç»“å©šåœºæ™¯å›¾ç‰‡
                this.marryImage = new Image();
                this.marryImage.src = 'marry2.png';
                this.marryImageLoaded = false;
                this.marryImage.onload = () => {
                    this.marryImageLoaded = true;
                };
                
                this.player = {
                    x: 80,
                    y: 0,
                    width: 70, // ç¼©å°ä¸ºåŸæ¥çš„1/2
                    height: 85, // ç¼©å°ä¸ºåŸæ¥çš„1/2
                    vy: 0,
                    isGrounded: false,
                    isDucking: false,
                    jumpCount: 0,
                    ammo: config.maxAmmo
                };

                // UI Elements
                this.distDisplay = document.getElementById('dist-display');
                this.ammoDisplay = document.getElementById('ammo-display');
                this.coinDisplay = document.getElementById('coin-display');

                // Listeners
                window.addEventListener('resize', () => this.resize());
                
                window.addEventListener('keydown', (e) => {
                    if (this.state !== 'PLAYING') return;
                    if (e.code === 'Space' || e.code === 'ArrowUp') this.jump();
                    if (e.code === 'ArrowDown') this.duck(true);
                    if (e.code === 'KeyF') this.shoot();
                });
                window.addEventListener('keyup', (e) => {
                    if (e.code === 'ArrowDown') this.duck(false);
                });

                this.canvas.addEventListener('touchstart', (e) => {
                    if (this.state !== 'PLAYING') return;
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = this.canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;

                    if (y > rect.height * 0.7 && x < rect.width * 0.3) {
                        this.duck(true);
                    } else {
                        this.jump();
                    }
                }, {passive: false});

                this.canvas.addEventListener('touchend', (e) => {
                    this.duck(false);
                });
                
                // åˆå§‹åŒ–ç™½äº‘
                this.clouds = [];
                this.initClouds();
            }

            initClouds() {
                // åˆå§‹åŒ–ç™½äº‘ï¼Œåœ¨ç”»å¸ƒä¸Šæ–¹éšæœºä½ç½®ç”Ÿæˆ
                this.clouds = [];
                const cloudCount = 8; // ç™½äº‘æ•°é‡
                for (let i = 0; i < cloudCount; i++) {
                    this.clouds.push({
                        x: Math.random() * this.displayWidth * 1.5 - this.displayWidth * 0.5, // ä»ç”»å¸ƒå·¦ä¾§å¤–å¼€å§‹
                        y: Math.random() * (this.displayHeight * 0.4), // åœ¨ä¸ŠåŠéƒ¨åˆ†
                        width: 80 + Math.random() * 60, // éšæœºå®½åº¦
                        height: 40 + Math.random() * 30, // éšæœºé«˜åº¦
                        speed: 0.3 + Math.random() * 0.4, // éšæœºé€Ÿåº¦
                        opacity: 0.6 + Math.random() * 0.3 // éšæœºé€æ˜åº¦
                    });
                }
            }

            resize() {
                // è·å–è®¾å¤‡åƒç´ æ¯”ï¼Œæé«˜é«˜DPIå±å¹•çš„æ¸…æ™°åº¦
                const dpr = window.devicePixelRatio || 1;
                this.displayWidth = window.innerWidth > 1200 ? 1200 : window.innerWidth;
                this.displayHeight = 800; // è¿›ä¸€æ­¥å¢å¤§ç”»å¸ƒé«˜åº¦ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ å®Œæ•´æ˜¾ç¤º
                
                // è®¾ç½®Canvasçš„å®é™…åƒç´ å°ºå¯¸ï¼ˆè€ƒè™‘è®¾å¤‡åƒç´ æ¯”ï¼‰
                this.canvas.width = this.displayWidth * dpr;
                this.canvas.height = this.displayHeight * dpr;
                
                // è®¾ç½®Canvasçš„CSSæ˜¾ç¤ºå°ºå¯¸
                this.canvas.style.width = this.displayWidth + 'px';
                this.canvas.style.height = this.displayHeight + 'px';
                
                // é‡ç½®å˜æ¢çŸ©é˜µå¹¶åº”ç”¨è®¾å¤‡åƒç´ æ¯”ç¼©æ”¾ï¼ˆé¿å…ç´¯ç§¯ï¼‰
                this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                
                // å¯ç”¨é«˜è´¨é‡å›¾åƒå¹³æ»‘
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
            }

            start() {
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('game-over-screen').classList.add('hidden');
                this.resetGameData();
                this.state = 'PLAYING';
                this.loop();
            }

            reset() {
                document.getElementById('game-over-screen').classList.add('hidden');
                this.resetGameData();
                this.state = 'PLAYING';
                this.loop();
            }

            resetGameData() {
                // ä½¿ç”¨æ˜¾ç¤ºé«˜åº¦è€Œä¸æ˜¯å®é™…åƒç´ é«˜åº¦ï¼ˆè€ƒè™‘devicePixelRatioï¼‰
                this.player.y = this.displayHeight - config.groundHeight - this.player.height;
                this.player.vy = 0;
                this.player.isDucking = false;
                this.player.jumpCount = 0;
                this.player.ammo = config.maxAmmo;
                
                this.distance = 0;
                this.coins = 0;
                this.frame = 0;
                this.obstacles = [];
                this.collectibles = [];
                this.particles = [];
                this.projectiles = [];
                this.lastObstacleFrame = 0; // é‡ç½®éšœç¢ç‰©ç”Ÿæˆè®¡æ—¶
                this.clouds = []; // é‡ç½®ç™½äº‘
                this.initClouds(); // é‡æ–°åˆå§‹åŒ–ç™½äº‘
                this.married = false; // é‡ç½®ç»“å©šçŠ¶æ€
                
                this.updateUI();
            }

            jump() {
                if (this.player.isGrounded) {
                    this.player.vy = config.jumpForce;
                    this.player.isGrounded = false;
                    this.player.jumpCount = 1;
                    this.spawnParticles(this.player.x + 20, this.player.y + 60, '#0ff', 5);
                } else if (this.player.jumpCount < 2) {
                    this.player.vy = config.jumpForce * 0.9;
                    this.player.jumpCount++;
                    this.spawnParticles(this.player.x + 20, this.player.y + 60, '#f0f', 5);
                }
            }

            duck(isDucking) {
                this.player.isDucking = isDucking;
                if (isDucking && !this.player.isGrounded) {
                    this.player.vy += 3;
                }
            }

            shoot() {
                if (this.state !== 'PLAYING') return;
                if (this.player.ammo > 0) {
                    this.player.ammo--;
                    // å­å¼¹ä»äººç‰©èº«ä½“å³ä¾§å‘å°„ï¼Œä½ç½®åœ¨äººç‰©é«˜åº¦çš„ä¸­ä¸Šéƒ¨ï¼Œç¡®ä¿èƒ½å‡»ä¸­éšœç¢ç‰©
                    let bulletX = this.player.x + this.player.width - 12;
                    let bulletY = this.player.y + (this.player.isDucking ? this.player.height * 0.4 : this.player.height * 0.35);
                    this.projectiles.push({
                        x: bulletX,
                        y: bulletY,
                        width: 25,
                        height: 25,
                        speed: 8
                    });
                    this.updateUI();
                }
            }

            spawnObstacle() {
                // å¤§å¹…å¢åŠ é—´è·ï¼Œé¿å…å¯†é›†å’Œé‡å 
                // æœ€å°é—´éš”ï¼š200å¸§ï¼ˆçº¦3-4ç§’ï¼‰ï¼Œéšæœºå¢åŠ 0-150å¸§
                const minGap = 200;
                const randomGap = Math.floor(Math.random() * 150);
                const totalGap = minGap + randomGap;
                
                // æ£€æŸ¥è·ç¦»ä¸Šæ¬¡ç”Ÿæˆéšœç¢ç‰©æ˜¯å¦å·²ç»è¿‡äº†è¶³å¤Ÿçš„æ—¶é—´
                if (this.frame - this.lastObstacleFrame >= totalGap) {
                    // æ£€æŸ¥ç”»å¸ƒå³ä¾§æ˜¯å¦å·²ç»æœ‰éšœç¢ç‰©ï¼Œé¿å…é‡å 
                    const minDistance = 250; // éšœç¢ç‰©ä¹‹é—´çš„æœ€å°è·ç¦»ï¼ˆåƒç´ ï¼‰
                    let canSpawn = true;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰éšœç¢ç‰©è·ç¦»ç”»å¸ƒå³ä¾§å¤ªè¿‘
                    for (let obs of this.obstacles) {
                        if (obs.x > this.displayWidth - minDistance) {
                            canSpawn = false;
                            break;
                        }
                    }
                    
                    if (canSpawn) {
                        const template = sprites.obstacles[Math.floor(Math.random() * sprites.obstacles.length)];
                        this.obstacles.push({
                            x: this.displayWidth,
                            y: this.displayHeight - config.groundHeight - template.yOffset - template.height,
                            width: template.width,
                            height: template.height,
                            icon: template.icon,
                            name: template.name,
                            hp: 1
                        });
                        this.lastObstacleFrame = this.frame; // æ›´æ–°æœ€åç”Ÿæˆéšœç¢ç‰©çš„å¸§æ•°
                    }
                }
            }

            spawnCollectible() {
                // è®ºæ–‡é‡‘å¸ç”Ÿæˆ
                if (this.frame % 100 === 0 && Math.random() > 0.4) {
                    // ç¡®ä¿ç”Ÿæˆåœ¨æ¯”è¾ƒå®¹æ˜“åƒåˆ°çš„ä½ç½®
                    const isHigh = Math.random() > 0.5; // ä¸€åŠæ¦‚ç‡åœ¨é«˜å¤„
                    const yPos = isHigh ? 
                        this.displayHeight - config.groundHeight - 160 : 
                        this.displayHeight - config.groundHeight - 80;

                    this.collectibles.push({
                        x: this.displayWidth,
                        y: yPos,
                        width: 50,
                        height: 60,
                        icon: sprites.paper.icon,
                        value: sprites.paper.value,
                        floatOffset: Math.random() * Math.PI * 2
                    });
                }
            }

            spawnParticles(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 6,
                        vy: (Math.random() - 0.5) * 6,
                        life: 40,
                        color: color
                    });
                }
            }

            update() {
                if (this.state !== 'PLAYING') return;

                this.frame++;
                this.distance += config.speed / 10;
                this.updateUI();

                // ç‰©ç†å¼•æ“
                this.player.vy += config.gravity;
                this.player.y += this.player.vy;

                // ä½¿ç”¨æ˜¾ç¤ºé«˜åº¦è€Œä¸æ˜¯å®é™…åƒç´ é«˜åº¦
                const groundY = this.displayHeight - config.groundHeight;
                if (this.player.y + this.player.height >= groundY) {
                    this.player.y = groundY - this.player.height;
                    this.player.vy = 0;
                    this.player.isGrounded = true;
                    this.player.jumpCount = 0;
                } else {
                    this.player.isGrounded = false;
                }

                // å­å¼¹é€»è¾‘
                for (let i = this.projectiles.length - 1; i >= 0; i--) {
                    let p = this.projectiles[i];
                    p.x += p.speed;
                    if (p.x > this.displayWidth) {
                        this.projectiles.splice(i, 1);
                        continue;
                    }
                    // å‡»ä¸­éšœç¢ç‰©
                    for (let j = this.obstacles.length - 1; j >= 0; j--) {
                        let obs = this.obstacles[j];
                        if (p.x < obs.x + obs.width && p.x + p.width > obs.x &&
                            p.y < obs.y + obs.height && p.y + p.height > obs.y) {
                            this.spawnParticles(obs.x + obs.width/2, obs.y + obs.height/2, '#ff4757', 8);
                            this.obstacles.splice(j, 1);
                            this.projectiles.splice(i, 1);
                            break;
                        }
                    }
                }

                // ç”Ÿæˆé€»è¾‘
                // ä¸ºäº†ä¿è¯"åŸå ¡åé¢ä¸å†æœ‰ä»»ä½•éšœç¢ç‰©/è®ºæ–‡"ï¼Œ
                // åœ¨æ¥è¿‘ç»ˆç‚¹ï¼ˆæ¯”å¦‚æœ€å 80 ç±³ï¼‰å°±åœæ­¢ç”Ÿæˆæ–°çš„å…ƒç´ ï¼›
                // ä½†èƒœåˆ©åˆ¤å®šä»ç„¶åªç”±åŸå ¡ä½ç½®å†³å®šï¼ˆé¿å…æå‰ç»“æŸï¼‰ã€‚
                const spawnStopDistance = config.levelLength - 80;
                if (this.distance < spawnStopDistance) {
                    this.spawnObstacle();
                    this.spawnCollectible();
                }

                // ç¢°æ’åˆ¤å®šï¼šåªåœ¨æ°´å¹³æ–¹å‘ç¼©å°ä¸€ç‚¹ï¼Œå‚ç›´æ–¹å‘ä½¿ç”¨æ•´ä¸ªäººç‰©é«˜åº¦
                // è¿™æ ·æ—¢èƒ½æ’é™¤å›¾ç‰‡å·¦å³çš„é€æ˜åŒºåŸŸï¼Œåˆèƒ½ä¿è¯å¤´éƒ¨æ’åˆ°é¡¶éƒ¨éšœç¢ç‰©æ—¶ä¼šåˆ¤å®šç¢°æ’
                let bodyWidthRatio = 0.6;  // äººç‰©èº«ä½“å®½åº¦å å›¾ç‰‡å®½åº¦çš„æ¯”ä¾‹ï¼ˆå·¦å³å„ç•™ä¸€ç‚¹ç©ºéš™ï¼‰
                let bodyHeightRatio = 1.0; // ä½¿ç”¨æ•´ä¸ªäººç‰©é«˜åº¦ï¼ŒåŒ…å«å¤´é¡¶
                let bodyXOffset = (1 - bodyWidthRatio) / 2; // å·¦å³é€æ˜åŒºåŸŸçš„åç§»
                let bodyYOffset = 0; // å‚ç›´æ–¹å‘ä¸è£å‰ªï¼Œä¿è¯é¡¶éƒ¨éšœç¢ç‰©èƒ½è¢«æ£€æµ‹åˆ°
                
                let bodyX = this.player.x + this.player.width * bodyXOffset;
                let bodyWidth = this.player.width * bodyWidthRatio;
                let bodyH = this.player.isDucking ? this.player.height * bodyHeightRatio / 2 : this.player.height * bodyHeightRatio;
                let bodyY = this.player.isDucking ? 
                    this.player.y + this.player.height / 2 + this.player.height * bodyYOffset : 
                    this.player.y + this.player.height * bodyYOffset;

                // éšœç¢ç‰©ç¢°æ’ - åªæ£€æµ‹äººç‰©èº«ä½“éƒ¨åˆ†
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    let obs = this.obstacles[i];
                    obs.x -= config.speed;

                    // åªæ£€æµ‹äººç‰©èº«ä½“åŒºåŸŸçš„ç¢°æ’
                    if (bodyX < obs.x + obs.width &&
                        bodyX + bodyWidth > obs.x &&
                        bodyY < obs.y + obs.height &&
                        bodyY + bodyH > obs.y) {
                        this.gameOver(obs.name);
                    }
                    if (obs.x + obs.width < 0) this.obstacles.splice(i, 1);
                }

                // æ”¶é›†å“ç¢°æ’ (è®ºæ–‡)
                for (let i = this.collectibles.length - 1; i >= 0; i--) {
                    let c = this.collectibles[i];
                    c.x -= config.speed;
                    c.y += Math.sin(this.frame * 0.1 + c.floatOffset) * 0.5; // ä¸Šä¸‹æµ®åŠ¨

                    // ç¢°åˆ°å°±åƒ
                    if (this.player.x < c.x + c.width &&
                        this.player.x + this.player.width > c.x &&
                        this.player.y < c.y + c.height &&
                        this.player.y + this.player.height > c.y) {
                        
                        this.coins += c.value;
                        this.spawnParticles(c.x, c.y, '#ffd700', 5);
                        this.collectibles.splice(i, 1);
                        continue;
                    }
                    if (c.x + c.width < 0) this.collectibles.splice(i, 1);
                }

                // ç²’å­
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    let p = this.particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    if (p.life <= 0) this.particles.splice(i, 1);
                }

                // æ›´æ–°ç™½äº‘ä½ç½®ï¼ˆé£˜åŠ¨ï¼‰
                for (let i = 0; i < this.clouds.length; i++) {
                    let cloud = this.clouds[i];
                    cloud.x += cloud.speed;
                    // å¦‚æœç™½äº‘é£˜å‡ºç”»å¸ƒå³ä¾§ï¼Œé‡æ–°ä»å·¦ä¾§è¿›å…¥
                    if (cloud.x > this.displayWidth + cloud.width) {
                        cloud.x = -cloud.width;
                        cloud.y = Math.random() * (this.displayHeight * 0.4);
                    }
                }
            }

            drawCloud(x, y, width, height, opacity) {
                // ç»˜åˆ¶ä¸€æœµç™½äº‘ï¼Œä½¿ç”¨å¤šä¸ªåœ†å½¢ç»„åˆ
                this.ctx.save();
                this.ctx.globalAlpha = opacity;
                this.ctx.fillStyle = '#FFFFFF';
                
                // ä½¿ç”¨å¤šä¸ªåœ†å½¢ç»„åˆæˆäº‘æœµå½¢çŠ¶
                const segments = 4; // äº‘æœµçš„åœ†å½¢æ®µæ•°
                const segmentWidth = width / segments;
                
                for (let i = 0; i < segments; i++) {
                    const cx = x + segmentWidth * (i + 0.5);
                    const cy = y + height / 2;
                    const radius = height / 2;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                // æ·»åŠ ä¸€äº›é‡å çš„å°åœ†å½¢ï¼Œè®©äº‘æœµæ›´è‡ªç„¶
                this.ctx.beginPath();
                this.ctx.arc(x + width * 0.2, y + height * 0.3, height * 0.4, 0, Math.PI * 2);
                this.ctx.arc(x + width * 0.8, y + height * 0.3, height * 0.4, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.restore();
            }

            updateUI() {
                this.distDisplay.innerText = Math.max(0, Math.floor(this.distance));
                this.ammoDisplay.innerText = this.player.ammo;
                this.coinDisplay.innerText = this.coins;
            }

            draw() {
                // ç¡®ä¿ä½¿ç”¨é«˜è´¨é‡å›¾åƒå¹³æ»‘
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                
                // ä½¿ç”¨å­˜å‚¨çš„æ˜¾ç¤ºå°ºå¯¸
                this.ctx.clearRect(0, 0, this.displayWidth, this.displayHeight);
                
                // ç»˜åˆ¶å¤©ç©ºèƒŒæ™¯æ¸å˜ï¼šä»ä¸‹å¾€ä¸Šï¼Œåº•éƒ¨å¤§é¢ç§¯ç™½è‰² + ä¸Šæ–¹è“è‰²
                // 0 - 45%ï¼šçº¯ç™½ï¼ˆäººç‰©èƒ½è·‘å’Œè·³åˆ°çš„é«˜åº¦èŒƒå›´å†…éƒ½æ˜¯ç™½è‰²åº•ï¼‰
                // 45% - 100%ï¼šé€æ¸è¿‡æ¸¡ä¸ºè“è‰²å¤©ç©º
                const gradient = this.ctx.createLinearGradient(0, this.displayHeight, 0, 0);
                gradient.addColorStop(0,   '#FFFFFF'); // åº•éƒ¨ç™½è‰²
                gradient.addColorStop(0.45,'#FFFFFF'); // äººç‰©æ´»åŠ¨+è·³è·ƒåŒºåŸŸä¿æŒç™½è‰²
                gradient.addColorStop(0.7, '#E3F2FD'); // æµ…è“
                gradient.addColorStop(0.85,'#90CAF9'); // ä¸­è“
                gradient.addColorStop(1,   '#42A5F5'); // é¡¶éƒ¨è“è‰²ï¼ˆå¤©ç©ºï¼‰
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.displayWidth, this.displayHeight);
                
                // ç»˜åˆ¶ç™½äº‘
                this.ctx.save();
                for (let i = 0; i < this.clouds.length; i++) {
                    let cloud = this.clouds[i];
                    this.drawCloud(cloud.x, cloud.y, cloud.width, cloud.height, cloud.opacity);
                }
                this.ctx.restore();
 
                // ç»˜åˆ¶èµ›åšç½‘æ ¼åœ°é¢ï¼ˆå»æ‰é˜´å½±ï¼‰
                this.ctx.save();
                this.ctx.strokeStyle = '#f0f';
                this.ctx.lineWidth = 3;
                this.ctx.shadowBlur = 0;
                this.ctx.shadowColor = 'transparent';
                
                // åœ°é¢çº¿
                const groundY = this.displayHeight - config.groundHeight;
                this.ctx.beginPath();
                this.ctx.moveTo(0, groundY);
                this.ctx.lineTo(this.displayWidth, groundY);
                this.ctx.stroke();

                // çºµå‘ç½‘æ ¼çº¿ (ç§»åŠ¨æ•ˆæœ)
                const offset = (this.distance * 10) % 90; // å¢å¤§ç½‘æ ¼é—´è·
                for(let x = -offset; x < this.displayWidth; x += 90) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, groundY);
                    this.ctx.lineTo(x - 45, this.displayHeight); 
                    this.ctx.stroke();
                }
                this.ctx.restore();

                // æ”¶é›†å“ (è®ºæ–‡)ï¼ˆå»æ‰é˜´å½±ï¼‰
                this.ctx.font = '50px Arial';
                this.collectibles.forEach(c => {
                    this.ctx.shadowBlur = 0;
                    this.ctx.shadowColor = 'transparent';
                    this.ctx.fillText(c.icon, c.x, c.y + 50);
                });

                // éšœç¢ç‰©ï¼ˆå»æ‰é˜´å½±ï¼‰
                this.ctx.font = '60px Arial';
                this.obstacles.forEach(obs => {
                    this.ctx.shadowBlur = 0;
                    this.ctx.shadowColor = 'transparent';
                    this.ctx.fillText(obs.icon, obs.x, obs.y + 50);
                });

                // ç»ˆç‚¹
                if (this.distance > config.levelLength - 100 && !this.married) {
                    // æ ¹æ®ç”»é¢å¤§å°è‡ªé€‚åº”ç»ˆç‚¹ä½ç½®
                    let endX = this.displayWidth - (this.distance - (config.levelLength - 100)) * 10;
                    
                    // æ•´ä¸ªç»ˆç‚¹åŒºåŸŸï¼šä½¿ç”¨ cyp1.png è¿™ä¸€å¼ å›¾ç‰‡æ›¿ä»£åŸæ¥çš„åŸå ¡+å…¬ä¸»
                    if (this.princessImageLoaded) {
                        const targetHeight = this.displayHeight * 0.144; // ç»ˆç‚¹æ•´ä½“é«˜åº¦ï¼ˆç¼©å°åˆ°80%ï¼‰
                        const aspectRatio = this.princessImage.width / this.princessImage.height || 1;
                        const targetWidth = targetHeight * aspectRatio;
                        const castleX = endX; // ä»åŸæ¥åŸå ¡çš„ä½ç½®å¼€å§‹ç”»æ•´å¼ å›¾
                        const castleY = this.displayHeight - 100 - targetHeight; // å¾€ä¸Šç§»30åƒç´ 

                        this.ctx.drawImage(
                            this.princessImage,
                            castleX,
                            castleY,
                            targetWidth,
                            targetHeight
                        );
                        
                        // æ£€æµ‹äººç‰©å’Œç»ˆç‚¹çš„ç¢°æ’
                        if (this.player.x < castleX + targetWidth &&
                            this.player.x + this.player.width > castleX &&
                            this.player.y < castleY + targetHeight &&
                            this.player.y + this.player.height > castleY) {
                            // è§¦å‘ç»“å©šåœºæ™¯
                            this.married = true;
                            // å»¶è¿Ÿä¸€ç‚¹å†è§¦å‘èƒœåˆ©ï¼Œè®©marry2.pngå…ˆæ˜¾ç¤º
                            setTimeout(() => {
                                this.win();
                            }, 500);
                        }
                    } else {
                        // å¦‚æœå›¾ç‰‡è¿˜æ²¡åŠ è½½å¥½ï¼Œå°±é€€å›åˆ°åŸæ¥çš„ emoji æ–¹æ¡ˆï¼ˆåŸå ¡ + å…¬ä¸»ï¼‰
                        this.ctx.shadowBlur = 0;
                        this.ctx.shadowColor = 'transparent';
                        this.ctx.font = '150px Arial';
                        this.ctx.fillText(sprites.finish, endX, this.displayHeight - 100);
                        this.ctx.font = '120px Arial';
                        this.ctx.fillText(sprites.princess, endX + 120, this.displayHeight - 100);
                        
                        // emojiæ¨¡å¼çš„ç¢°æ’æ£€æµ‹
                        if (endX < this.player.x) {
                            this.married = true;
                            setTimeout(() => {
                                this.win();
                            }, 500);
                        }
                    }
                }
                
                // å¦‚æœå·²è§¦å‘ç»“å©šåœºæ™¯ï¼Œæ˜¾ç¤ºmarry2.pngï¼ˆå±…ä¸­æ˜¾ç¤ºï¼Œè¦†ç›–æ•´ä¸ªç”»é¢ï¼‰
                if (this.married && this.marryImageLoaded) {
                    const marryHeight = this.displayHeight * 0.6; // ç»“å©šå›¾ç‰‡å ç”»é¢é«˜åº¦çš„60%
                    const aspectRatio = this.marryImage.width / this.marryImage.height || 1;
                    const marryWidth = marryHeight * aspectRatio;
                    const marryX = (this.displayWidth - marryWidth) / 2; // å±…ä¸­
                    const marryY = (this.displayHeight - marryHeight) / 2; // å±…ä¸­
                    
                    this.ctx.drawImage(
                        this.marryImage,
                        marryX,
                        marryY,
                        marryWidth,
                        marryHeight
                    );
                }

                // å­å¼¹
                this.ctx.font = '35px Arial';
                this.projectiles.forEach(p => {
                    this.ctx.fillText(sprites.projectile, p.x, p.y + 25);
                });

                // --- ç©å®¶ç»˜åˆ¶åŒºåŸŸ ---
                // å¦‚æœå·²è§¦å‘ç»“å©šåœºæ™¯ï¼Œä¸ç»˜åˆ¶ç©å®¶
                if (!this.married) {
                    this.ctx.save();
                    
                    // ç»˜åˆ¶ç©å®¶æœ¬ä½“ - ä½¿ç”¨å›¾ç‰‡
                    if (this.playerImageLoaded) {
                    // è®¡ç®—ç»˜åˆ¶ä½ç½®å’Œå°ºå¯¸
                    let drawWidth = this.player.width;
                    let drawHeight = this.player.isDucking ? this.player.height / 2 : this.player.height;
                    let drawX = this.player.x;
                    let drawY = this.player.isDucking ? 
                        this.player.y + this.player.height / 2 : 
                        this.player.y;
                    // å†å¾€ä¸‹è°ƒä¸€ç‚¹ï¼šåªä¸Šç§»å°‘é‡åƒç´ ï¼ˆæ¯”ä¹‹å‰æ›´æ¥è¿‘åœ°é¢ï¼‰
                    drawY -= 3;
                    
                    // ç»˜åˆ¶å›¾ç‰‡ï¼Œç›´æ¥ç»˜åˆ¶ï¼ˆå‡è®¾å›¾ç‰‡æœ¬èº«å·²ç»æœå³ï¼‰
                    // å¦‚æœå›¾ç‰‡æœå·¦ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šï¼Œæ³¨é‡Šæ‰ç›´æ¥ç»˜åˆ¶çš„ä»£ç 
                    this.ctx.save();
                    // ç¡®ä¿ä½¿ç”¨é«˜è´¨é‡å›¾åƒå¹³æ»‘
                    this.ctx.imageSmoothingEnabled = true;
                    this.ctx.imageSmoothingQuality = 'high';
                    // ç¡®ä¿ä½¿ç”¨é»˜è®¤åˆæˆæ¨¡å¼ï¼Œæ”¯æŒé€æ˜èƒŒæ™¯
                    this.ctx.globalCompositeOperation = 'source-over';
                    // ç¡®ä¿é€æ˜åº¦ä¸º1ï¼Œä¸é®æŒ¡èƒŒæ™¯
                    this.ctx.globalAlpha = 1.0;
                    
                    // æ–¹æ¡ˆ1: å¦‚æœå›¾ç‰‡æœ¬èº«æœå³ï¼Œç›´æ¥ç»˜åˆ¶ï¼ˆä¸ç¿»è½¬ï¼‰
                    // PNGå›¾ç‰‡çš„é€æ˜éƒ¨åˆ†ä¼šè‡ªåŠ¨æ˜¾ç¤ºèƒŒæ™¯
                    this.ctx.drawImage(
                        this.playerImage,
                        drawX,
                        drawY,
                        drawWidth,
                        drawHeight
                    );
                    
                    // æ–¹æ¡ˆ2: å¦‚æœå›¾ç‰‡æœå·¦éœ€è¦ç¿»è½¬ä½¿å…¶æœå³ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼ˆæ³¨é‡Šæ‰ä¸Šé¢çš„ç›´æ¥ç»˜åˆ¶ï¼‰
                    // this.ctx.translate(drawX + drawWidth / 2, drawY);
                    // this.ctx.scale(-1, 1); // æ°´å¹³ç¿»è½¬ï¼Œä½¿å›¾ç‰‡æœå³
                    // this.ctx.drawImage(
                    //     this.playerImage,
                    //     -drawWidth / 2,
                    //     0,
                    //     drawWidth,
                    //     drawHeight
                    // );
                    
                    this.ctx.restore();
                } else {
                    // å¦‚æœå›¾ç‰‡è¿˜æ²¡åŠ è½½å®Œæˆï¼Œä½¿ç”¨ emoji ä½œä¸ºåå¤‡
                    this.ctx.translate(this.player.x + this.player.width / 2, this.player.y);
                    this.ctx.scale(-1, 1); // ç¿»è½¬ emoji
                    
                    let playerSprite = sprites.player;
                    if (!this.player.isGrounded) playerSprite = sprites.playerJump;
                    if (this.player.isDucking) playerSprite = sprites.playerDuck;

                    this.ctx.font = '55px Arial';
                    let drawY = this.player.isDucking ? 60 : 50;
                    this.ctx.fillText(playerSprite, -this.player.width / 2, drawY);
                }

                    this.ctx.restore(); // ç»“æŸç©å®¶ç»˜åˆ¶
                } // ç»“æŸ if (!this.married)

                // åå­—æ ‡ç­¾ï¼ˆåªåœ¨æœªç»“å©šæ—¶æ˜¾ç¤ºï¼‰
                if (!this.married) {
                    this.ctx.fillStyle = '#0ff';
                    this.ctx.font = '20px "Orbitron"';
                    this.ctx.shadowBlur = 0;
                    this.ctx.shadowColor = 'transparent';
                    this.ctx.fillText('WWF', this.player.x + 10, this.player.y - 15);
                }

                // ç²’å­ç‰¹æ•ˆ
                this.particles.forEach(p => {
                    this.ctx.fillStyle = p.color || '#fff';
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, 6, 0, Math.PI * 2); // å¢å¤§ç²’å­å¤§å°
                    this.ctx.fill();
                });
            }

            loop() {
                if (this.state === 'PLAYING') {
                    this.update();
                    this.draw();
                    requestAnimationFrame(() => this.loop());
                }
            }

            gameOver(reason) {
                this.state = 'GAMEOVER';
                document.getElementById('death-reason').innerText = `å®éªŒå¤±è´¥: æ’åˆ°äº† ${reason}`;
                document.getElementById('game-over-screen').classList.remove('hidden');
            }

            win() {
                if (this.state === 'WON') return;
                this.state = 'WON';
                setTimeout(() => {
                    this.startCeremony();
                }, 800);
            }

            startCeremony() {
                const screen = document.getElementById('ceremony-screen');
                screen.classList.remove('hidden');

                const giftBox = document.getElementById('gift-section');
                let gift = "";
                let emoji = "";
                
                // æ›´æ–°ç¤¼ç‰©æ–‡æ¡ˆé€»è¾‘ï¼ŒåŒ…å«ä½ è¦æ±‚çš„æœ€æ–°ç¤¼ç‰©
                if (this.coins >= 500) {
                    gift = "è±ªåå¤§ç¤¼åŒ…ï¼šåº¦å‡ + ç¯çƒå½±åŸ + æ°¸è¿œè¿‡ç¨¿buff";
                    emoji = "ğŸ–ï¸ğŸ¢âœ…";
                } else if (this.coins >= 300) {
                    gift = "é«˜çº§ç¤¼ç‰©ï¼šæœ€æ–°æ¬¾åŒ…åŒ… + é¡¶çº§è¯•å‰‚å¥—è£…";
                    emoji = "ğŸ‘œğŸ§ª";
                } else if (this.coins >= 100) {
                    gift = "è´´å¿ƒç¤¼ç‰©ï¼šä¸€æ”¯æ˜‚è´µçš„å£çº¢ + å¥¶èŒ¶åˆ¸";
                    emoji = "ğŸ’„ğŸ§‹";
                } else {
                    gift = "åŸºç¡€ç¤¼ç‰©ï¼šä¸€ç¯‡å†™å¥½çš„è®ºæ–‡åˆç¨¿";
                    emoji = "ğŸ“„";
                }

                giftBox.innerHTML = `
                    <div style="font-size: 1rem; color: #fff;">æ”¶é›†è®ºæ–‡æ•°(é‡‘å¸): <span style="color:#ffd700">${this.coins}</span></div>
                    <div style="margin-top:10px; font-size:1.1rem;">ä¸ºå…¬ä¸»å…‘æ¢äº†:</div>
                    <div style="font-size: 1.3rem; margin-top:5px; color:#0ff; text-shadow:0 0 5px #0ff;">${gift} ${emoji}</div>
                `;
                
                // é¥­åº—å¡ç‰‡
                const grid = document.getElementById('card-grid');
                grid.innerHTML = '';
                const restaurants = [
                    "å¤©æˆå·èœ", "ç®€æ‚¦å¨", "JuiceRobot\næ‰‹å·¥æ„å¤§åˆ©é¢", 
                    "æ¡‚æ´¾ç‰›æ–™", "ä¸²å°ç™½çƒ§çƒ¤", "æ´¥æ´¥èœé¦†", 
                    "æµ·åº•æ", "ä¸‹æ¬¡ä¸€å®š", "å†æ¥ä¸€æ¬¡"
                ];
                restaurants.sort(() => Math.random() - 0.5);

                restaurants.forEach((name) => {
                    const card = document.createElement('div');
                    card.className = 'card';

                    // ç‰¹æ®Šå¡ç‰‡ï¼š"ä¸‹æ¬¡ä¸€å®š" -> ä½¿ç”¨ marry.png èƒŒæ™¯ + "é©¬ä¸Šç»“å©š"æ–‡æ¡ˆ
                    if (name === "ä¸‹æ¬¡ä¸€å®š") {
                        card.innerHTML = `
                            <div class="card-inner">
                                <div class="card-front">?</div>
                                <div class="card-back marry-card">
                                    <div class="marry-text">é©¬ä¸Šç»“å©š</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // å…¶ä»–å¡ç‰‡ä¿æŒåŸæœ‰æ–‡å­—æ˜¾ç¤º
                        card.innerHTML = `
                            <div class="card-inner">
                                <div class="card-front">?</div>
                                <div class="card-back">${name.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    }
                    card.onclick = function() {
                        this.classList.toggle('flipped');
                    };
                    grid.appendChild(card);
                });
            }
        }

        const game = new Game();
    </script>
</body>
</html>

